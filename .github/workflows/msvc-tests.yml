name: Build and Test TicTacToe

on:
  push:
    branches: [ '**' ]       # Runs on push to any branch
  pull_request:
    branches: [ '**' ]       # Runs on any PR

jobs:
  build-and-test:
    runs-on: windows-2022

    steps:
      # 1. Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. Setup MSBuild tools
      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v1

      # 3. Restore NuGet packages (if applicable)
      - name: Restore NuGet packages
        run: nuget restore TicTacToe_Fall2023.sln

      # 4. Build the solution
      - name: Build solution
        run: msbuild TicTacToe_Fall2023.sln /p:Configuration=Debug /m

      # 5. Run native C++ tests using VsTest
      - name: Run tests
        uses: microsoft/vstest@v1
        with:
          testAssembly: '**\TicTacToeTest.dll'  # Automatically finds the test DLL
          platform: 'x64'
          configuration: 'Debug'
          runSettings: |
            <RunSettings>
              <RunConfiguration>
                <ResultsDirectory>TestResults</ResultsDirectory>
                <MaxCpuCount>0</MaxCpuCount>
                <TargetPlatform>x64</TargetPlatform>
                <TargetFrameworkVersion>Framework45</TargetFrameworkVersion>
                <DisableAppDomain>true</DisableAppDomain>
              </RunConfiguration>
            </RunSettings>
          diag: 'TestResults\VSTestDiag.log'  # Diagnostic log for debugging

      # 6. Upload test results to GitHub Actions
      - name: Publish test results
        uses: actions/upload-artifact@v3
        with:
          name: TestResults
          path: TestResults
